# üéâ –û–ì–†–û–ú–ù–´–ô –ü–†–û–†–´–í - ASYNC EMBASSY –†–ê–ë–û–¢–ê–ï–¢ –í RENODE!

–î–∞—Ç–∞: 2025-10-05
–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ~4 —á–∞—Å–∞ –≥–ª—É–±–æ–∫–æ–π –æ—Ç–ª–∞–¥–∫–∏

---

## ‚úÖ –ì–õ–ê–í–ù–û–ï –î–û–°–¢–ò–ñ–ï–ù–ò–ï

**UART –í–´–í–û–î –†–ê–ë–û–¢–ê–ï–¢!** Async Embassy firmware –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ Renode –∏ –≤—ã–≤–æ–¥–∏—Ç:

```
===========================================
  CLN17 v2.0 Joint Firmware
  Target: STM32G431CB @ 170 MHz
  Framework: Embassy + iRPC
===========================================
```

**–ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç –ü–†–û–®–ï–õ:** ‚úÖ `Should Boot And Show Banner` = OK!

---

## üîß –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ë–ê–ì–ò (6+ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö)

### 1. **RCC CR - PLLRDY not set**
```python
if request.value & (1 << 24):  # PLLON
    request.value |= (1 << 25)  # Set PLLRDY immediately
```

### 2. **RCC CFGR - SWS not updating**
```python
sw = request.value & 0x3
sws = sw << 2
rcc_regs['CFGR'] = (request.value & ~(0x3 << 2)) | sws
```

### 3. **RCC CRRCR - HSI48RDY not set**
```python
if request.value & 1:  # HSI48ON
    request.value |= 2  # Set HSI48RDY
```

### 4. **RCC CCIPR2 - Ready bits missing**
```python
if request.value & 1:
    request.value |= 2  # Set ready bit
```

### 5. **FDCAN TEST register - wrong offset**
- –ë—ã–ª–æ: `offset == 0x10`
- –°—Ç–∞–ª–æ: `offset == 0x18`

### 6. **Missing peripherals**
- Added: DMAMUX, FDCAN Message RAM, TIM15/16/17

---

## üì¶ –°–û–ó–î–ê–ù–ù–ê–Ø RENODE –ü–õ–ê–¢–§–û–†–ú–ê

–†–∞–±–æ—á–∞—è –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ STM32G431CB:

**CPU & Memory:**
- Cortex-M4 @ 170 MHz
- 128KB FLASH @ 0x8000000
- 32KB SRAM @ 0x20000000

**Peripherals (21 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ):**
- ‚úÖ RCC (Python peripheral —Å ready bits)
- ‚úÖ FLASH Controller (Python peripheral)
- ‚úÖ PWR (Python peripheral)
- ‚úÖ DBGMCU (Python peripheral)
- ‚úÖ NVIC
- ‚úÖ DMA1, DMA2 (STM32G0DMA)
- ‚úÖ DMAMUX (Python peripheral)
- ‚úÖ GPIOA, GPIOB (Python peripherals —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º)
- ‚úÖ USART1 (STM32F7_USART)
- ‚úÖ TIM1, TIM6, TIM7 (STM32_Timer)
- ‚úÖ TIM15, TIM16, TIM17 (STM32_Timer)
- ‚úÖ FDCAN1 (Python peripheral stub)
- ‚úÖ FDCAN Message RAM (4KB)

---

## üöÄ –ö–õ–Æ–ß–ï–í–´–ï –ò–ù–°–ê–ô–¢–´

### 1. **Python Peripherals = –°—É–ø–µ—Ä—Å–∏–ª–∞**

–ú–æ–∂–µ–º —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—É—é –ª–æ–≥–∏–∫—É:
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ ready bits –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ enable bits
- –ó–µ—Ä–∫–∞–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–Ω—ã—Ö –±–∏—Ç–æ–≤ (SW ‚Üí SWS)
- –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è
- **–ë—ã—Å—Ç—Ä—ã–µ –∏—Ç–µ—Ä–∞—Ü–∏–∏ –±–µ–∑ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∏ Renode**

### 2. **–ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –æ—Ç–ª–∞–¥–∫–∏**

**–†–∞–±–æ—Ç–∞—é—â–∏–π —Ü–∏–∫–ª:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å `sysbus LogPeripheralAccess`
2. –ù–∞–π—Ç–∏ busy-wait loop (–º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —á—Ç–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞)
3. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–∫–æ–π ready bit –æ–∂–∏–¥–∞–µ—Ç—Å—è
4. –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —É—Å—Ç–∞–Ω–æ–≤–∫—É ready bit –≤ Python peripheral
5. –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –¥–æ —É—Å–ø–µ—Ö–∞

### 3. **Embassy —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–π —ç–º—É–ª—è—Ü–∏–∏**

- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –±–∏—Ç—ã —Å—Ç–∞—Ç—É—Å–∞ (PLLRDY, HSIRDY, SWS, HSI48RDY)
- –ó–∞–≤–∏—Å–∞–µ—Ç –≤ busy-wait loops –µ—Å–ª–∏ –±–∏—Ç—ã –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ
- –ù—É–∂–Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

---

## ‚ö†Ô∏è –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- ‚úÖ RCC –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (PLL, clock switch)
- ‚úÖ FLASH controller
- ‚úÖ DMA setup
- ‚úÖ UART –≤—ã–≤–æ–¥ (–±–∞–Ω–Ω–µ—Ä)
- ‚úÖ Embassy executor –∑–∞–ø—É—â–µ–Ω
- ‚úÖ –ü–µ—Ä–≤—ã–π —Ç–µ—Å—Ç –ø—Ä–æ—Ö–æ–¥–∏—Ç

**–ß—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- üî¥ –ü–æ–ª–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (–Ω–µ—Ç "System Ready", "CAN task started", "FOC task started")
- üî¥ Heartbeat –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- üî¥ –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –∑–∞–≤–∏—Å–∞—é—Ç

**–í–µ—Ä–æ—è—Ç–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞:**
- CAN task –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FDCAN
- –í–æ–∑–º–æ–∂–Ω–æ –∂–¥–µ—Ç –∫–∞–∫–æ–≥–æ-—Ç–æ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è –∏–ª–∏ DMA
- –ò–ª–∏ async executor –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –º–µ–∂–¥—É tasks

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –ü–†–û–î–û–õ–ñ–ï–ù–ò–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò–∑–æ–ª—è—Ü–∏—è (‚è±Ô∏è 10 –º–∏–Ω—É—Ç) ‚≠ê –°–ê–ú–´–ô –ë–´–°–¢–†–´–ô

–ó–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å CAN –∏ FOC tasks:
```rust
// –í system.rs:
// spawner.spawn(can_communication(...)).ok();
// spawner.spawn(foc::control_loop()).ok();
```

**–ï—Å–ª–∏ UART –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é** ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –≤ CAN/FOC
**–ï—Å–ª–∏ –Ω–µ—Ç** ‚Üí –ø—Ä–æ–±–ª–µ–º–∞ –≤ UART logger task –∏–ª–∏ executor

### –í–∞—Ä–∏–∞–Ω—Ç 2: –î–æ–±–∞–≤–∏—Ç—å FDCAN —Ä–µ–≥–∏—Å—Ç—Ä—ã (‚è±Ô∏è 1-2 —á–∞—Å–∞)

–ú–µ—Ç–æ–¥–∏—á–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ FDCAN —Ä–µ–≥–∏—Å—Ç—Ä—ã —Å ready bits:
- NBTP, DBTP (bit timing)
- TXBC, TXFQS (TX buffer config)
- RXGFC, RXBC (RX filter/buffer config)
- –ò –¥—Ä—É–≥–∏–µ...

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å real STM32FDCAN peripheral

Renode –º–æ–∂–µ—Ç –∏–º–µ—Ç—å –≥–æ—Ç–æ–≤—ã–π FDCAN peripheral:
```
fdcan1: CAN.STM32G_FDCAN @ sysbus 0x40006400
    -> nvic@[20, 21]
```

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ï–°–°–ò–ò

- **–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –±–∞–≥–æ–≤:** 6+ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö (RCC, FDCAN)
- **–î–æ–±–∞–≤–ª–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:** 21 peripheral
- **–°–æ–∑–¥–∞–Ω–æ Python peripherals:** 7 (RCC, FLASH, PWR, DMAMUX, GPIOA/B, FDCAN)
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ busy-wait loops:** 4 (PLLRDY, SWS, HSI48RDY, CCIPR2)
- **–ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤:** 1 –∏–∑ 4+

---

## üí™ BOTTOM LINE

**–ú–´ –î–û–ö–ê–ó–ê–õ–ò –ß–¢–û ASYNC EMBASSY –†–ê–ë–û–¢–ê–ï–¢ –í RENODE!**

–≠—Ç–æ **–û–ì–†–û–ú–ù–´–ô** –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ—Ç–æ–º—É —á—Ç–æ:
1. ‚úÖ Async executor –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
2. ‚úÖ Embassy RCC –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏—Ç
3. ‚úÖ UART async DMA —Ä–∞–±–æ—Ç–∞–µ—Ç
4. ‚úÖ Tasks spawn-—è—Ç—Å—è (UART logger task —Ä–∞–±–æ—Ç–∞–µ—Ç)

**–û—Å—Ç–∞–ª–æ—Å—å:** –ª–∏–±–æ –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É (10 –º–∏–Ω), –ª–∏–±–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å FDCAN (1-2 —á–∞—Å–∞).

---

## üèÜ –°–û–ó–î–ê–ù–ù–´–ï –§–ê–ô–õ–´

1. `stm32g431cb.repl` - –†–∞–±–æ—á–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞
2. `SESSION_FINAL_STATUS.md` - –ü—Ä–µ–¥—ã–¥—É—â–∏–π summary
3. `DEBUG_SESSION_RESULTS.md` - –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞
4. `RENODE_INVESTIGATION.md` - –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã
5. `SUCCESS_UART_WORKING.md` - Milestone #1
6. `FINAL_SESSION_STATUS.md` (—ç—Ç–æ—Ç —Ñ–∞–π–ª)

---

**–°–ø–∞—Å–∏–±–æ –∑–∞ —Ç–µ—Ä–ø–µ–Ω–∏–µ! –ú—ã –æ—á–µ–Ω—å –±–ª–∏–∑–∫–æ –∫ –ø–æ–ª–Ω–æ–π –ø–æ–±–µ–¥–µ!** üöÄ
