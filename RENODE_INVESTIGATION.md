# –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã UART –≤ Renode

## üéØ –°—Ç–∞—Ç—É—Å: –õ–ò–ù–ö–ï–† –ò–°–ü–†–ê–í–õ–ï–ù, –ü–†–û–®–ò–í–ö–ê –°–û–ë–ò–†–ê–ï–¢–°–Ø –ò –ó–ê–ì–†–£–ñ–ê–ï–¢–°–Ø

### ‚úÖ –†–ï–®–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

1. **–õ–∏–Ω–∫–µ—Ä —Å–∫—Ä–∏–ø—Ç**:
   - ‚ùå –ü—Ä–æ–±–ª–µ–º–∞: –∫–∞—Å—Ç–æ–º–Ω—ã–π `memory.x` –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞–ª —Å Embassy
   - ‚úÖ –†–µ—à–µ–Ω–∏–µ: —É–¥–∞–ª–∏–ª–∏ `memory.x`, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ—Ç Embassy —Å feature `"memory-x"`
   - ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç: Entry Point = `0x80001D9` (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å –≤ FLASH)

2. **Build —Å–∏—Å—Ç–µ–º–∞**:
   - –°–æ–∑–¥–∞–Ω `build.rs` —Å –ª–∏–Ω–∫–µ—Ä —Ñ–ª–∞–≥–∞–º–∏: `--nmagic`, `-Tlink.x`, `-Tdefmt.x`
   - –£–¥–∞–ª–µ–Ω –¥—É–±–ª–∏–∫–∞—Ç `-Tmemory.x` –∏–∑ `.cargo/config.toml`

3. **–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏**:
   - –î–æ–±–∞–≤–ª–µ–Ω `cortex-m` —Å `"critical-section-single-core"`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã features –¥–ª—è `embassy-stm32`: `"time-driver-any"`, `"unstable-pac"`, `"exti"`
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã features –¥–ª—è `embassy-time`: `"defmt"`, `"defmt-timestamp-uptime"`, `"tick-hz-32_768"`
   - –£–¥–∞–ª–µ–Ω –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—â–∏–π `stm32g4` PAC (—É–∂–µ –µ—Å—Ç—å —á–µ—Ä–µ–∑ Embassy)

4. **Renode –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞**:
   - –°–æ–∑–¥–∞–Ω–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ STM32G0
   - Cortex-M4 CPU (–≤–º–µ—Å—Ç–æ M0+)
   - DMA1 –∏ DMA2 –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã (STM32G0DMA)
   - USART1 (STM32F7_USART) –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –∞–¥—Ä–µ—Å–µ `0x40013800`
   - GPIO, RCC, PWR, DBGMCU –ø–µ—Ä–∏—Ñ–µ—Ä–∏—è

### ‚ö†Ô∏è –¢–ï–ö–£–©–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: UART –ù–ï –í–´–í–û–î–ò–¢ –í RENODE

#### –°–∏–º–ø—Ç–æ–º—ã:
- –ü—Ä–æ—à–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ Renode
- –ù–µ—Ç –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞–º USART1
- –¢–µ—Å—Ç—ã –∑–∞–≤–∏—Å–∞—é—Ç –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ UART –≤—ã–≤–æ–¥–∞

#### –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã (–∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–æ):

1. **DMA –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**:
   - Embassy UART –∏—Å–ø–æ–ª—å–∑—É–µ—Ç DMA –¥–ª—è async –æ–ø–µ—Ä–∞—Ü–∏–π
   - DMA –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ `.repl`, –Ω–æ –º–æ–≥—É—Ç –Ω–µ —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é
   - STM32G0DMA –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç STM32G4 DMA

2. **Clock/RCC –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**:
   - Embassy –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç clocks —á–µ—Ä–µ–∑ RCC
   - –ù–∞—à RCC - —ç—Ç–æ Python stub, –∫–æ—Ç–æ—Ä—ã–π –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `0xFFFFFFFF`
   - –í–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—à–∏–≤–∫–∞ –∂–¥–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö RCC –±–∏—Ç–æ–≤ –ø–µ—Ä–µ–¥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π UART

3. **GPIO Alternate Functions**:
   - UART —Ç—Ä–µ–±—É–µ—Ç GPIO AF configuration (PA9/PA10)
   - STM32_GPIOPort –º–æ–∂–µ—Ç –Ω–µ —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å AF –ø–æ–ª–Ω–æ—Å—Ç—å—é
   - GPIO –∞–¥—Ä–µ—Å–∞: `0x48000000` –¥–ª—è STM32G4 (–Ω–µ `0x50000000` –∫–∞–∫ –≤ G0)

4. **Async executor**:
   - Embassy –∏—Å–ø–æ–ª—å–∑—É–µ—Ç async executor –¥–ª—è UART tasks
   - –í–æ–∑–º–æ–∂–Ω–æ executor –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç –∏–ª–∏ –∑–∞–≤–∏—Å–∞–µ—Ç

#### –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç:

```rust
// –í system.rs - async UART
let mut uart = Uart::new(
    p.USART1,
    p.PA10, // RX
    p.PA9,  // TX
    UartIrqs,
    p.DMA1_CH1,  // TX DMA
    p.DMA1_CH2,  // RX DMA
    uart_log::uart_config(),
).expect("UART init failed");

let _ = uart.write(b"Hello\r\n").await.ok();
```

–≠—Ç–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:
- –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- –ù–µ –≤—ã–∑—ã–≤–∞–µ—Ç panic –≤ Renode
- –ù–æ –Ω–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ USART1 —Ä–µ–≥–∏—Å—Ç—Ä–∞–º

---

## üîç –ù–ê–ô–î–ï–ù–ù–´–ï –ü–†–ò–ú–ï–†–´

### Embassy STM32F4 - Blocking UART (–ë–ï–ó DMA):
```rust
let mut usart = Uart::new_blocking(p.USART3, p.PD9, p.PD8, config).unwrap();
unwrap!(usart.blocking_write(b"Hello Embassy World!\r\n"));
```

### Embassy STM32F4 - Async UART (–° DMA):
```rust
let mut usart = Uart::new(p.USART3, p.PD9, p.PD8, Irqs, p.DMA1_CH3, p.DMA1_CH1, config).unwrap();
unwrap!(usart.write(s.as_bytes()).await);
```

### STM32G0 Platform –≤ Renode:
```
usart1: UART.STM32F7_USART @ sysbus 0x40013800
    frequency: 200000000
    IRQ -> nvic@27

dma1: DMA.STM32G0DMA @ sysbus 0x40020000
    numberOfChannels: 7
```

---

## üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –ü–†–û–î–û–õ–ñ–ï–ù–ò–Ø

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å Blocking UART (–ë–ï–ó DMA)
**–ü–ª—é—Å—ã:**
- –ú–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ø–æ–ª–Ω–æ–π —ç–º—É–ª—è—Ü–∏–∏ DMA
- –ü—Ä–æ—â–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ë—ã—Å—Ç—Ä–µ–µ –Ω–∞–π—Ç–∏ –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ (—É–±—Ä–∞—Ç—å async)
- –ú–µ–Ω–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –¥–ª—è production

**–ö–æ–¥:**
```rust
let mut uart = Uart::new_blocking(
    p.USART1,
    p.PA9,  // TX
    p.PA10, // RX
    uart_log::uart_config(),
).expect("UART init failed");

uart.blocking_write(b"Hello Renode!\r\n").expect("UART write failed");
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–ª—É—á—à–∏—Ç—å RCC stub
**–ü–ª—é—Å—ã:**
- –ú–æ–∂–µ—Ç —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É –µ—Å–ª–∏ Embassy –ø—Ä–æ–≤–µ—Ä—è–µ—Ç RCC –±–∏—Ç—ã
- –ë–æ–ª–µ–µ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —ç–º—É–ª—è—Ü–∏—è

**–ú–∏–Ω—É—Å—ã:**
- –¢—Ä–µ–±—É–µ—Ç –∑–Ω–∞–Ω–∏—è STM32G4 RCC —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
- –ú–æ–∂–µ—Ç –Ω–µ —Ä–µ—à–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É

**–ß—Ç–æ –Ω—É–∂–Ω–æ:**
- –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å RCC_CR (Clock Control Register)
- –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å RCC_CFGR (Clock Configuration)
- –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å RCC_APB2ENR (USART1 clock enable)

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `defmt-rtt` –≤–º–µ—Å—Ç–æ UART
**–ü–ª—é—Å—ã:**
- `defmt` —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ª–æ–≥–∏ —á–µ—Ä–µ–∑ RTT)
- Renode –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç RTT
- –ù–µ –Ω—É–∂–µ–Ω UART

**–ú–∏–Ω—É—Å—ã:**
- –ù—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å RTT –≤ Renode
- –¢–µ—Å—Ç—ã –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –Ω–∞ RTT –≤–º–µ—Å—Ç–æ UART

### –í–∞—Ä–∏–∞–Ω—Ç 4: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å GPIO configuration
**–ü–ª—é—Å—ã:**
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã
- GPIO AF –≤–∞–∂–µ–Ω –¥–ª—è UART

**–ú–∏–Ω—É—Å—ã:**
- –°–ª–æ–∂–Ω–æ –æ—Ç–ª–∞–¥–∏—Ç—å –±–µ–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- –ú–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è `.repl`

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–æ—Ä—è–¥–æ–∫):

1. **[–ë–´–°–¢–†–û] –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å blocking UART** - 15-20 –º–∏–Ω—É—Ç
   - –ò–∑–º–µ–Ω–∏—Ç—å `system.rs` –Ω–∞ `new_blocking`
   - –£–±—Ä–∞—Ç—å async/await
   - –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

2. **[–°–†–ï–î–ù–ï] –î–æ–±–∞–≤–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ RCC stub** - 30 –º–∏–Ω—É—Ç
   - –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ RCC
   - –ü–æ–Ω—è—Ç—å –∫–∞–∫–∏–µ –±–∏—Ç—ã –ø—Ä–æ–≤–µ—Ä—è–µ—Ç Embassy
   - –≠–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –Ω—É–∂–Ω—ã–µ –±–∏—Ç—ã

3. **[–î–û–õ–ì–û] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RTT –¥–ª—è —Ç–µ—Å—Ç–æ–≤** - 1-2 —á–∞—Å–∞
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å RTT –≤ Renode
   - –ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ RTT
   - –û—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç UART –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

4. **[–ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï] –û—Ç–ª–∞–¥–∏—Ç—å GPIO AF** - 1 —á–∞—Å
   - –î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ GPIO —Ä–µ–≥–∏—Å—Ç—Ä–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å AF –¥–ª—è PA9/PA10
   - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –µ—Å–ª–∏ –Ω—É–∂–Ω–æ

---

## üìö –ü–û–õ–ï–ó–ù–´–ï –°–°–´–õ–ö–ò

- [Embassy Examples](https://github.com/embassy-rs/embassy/tree/main/examples)
- [Renode Documentation](https://renode.readthedocs.io/)
- [STM32G4 Reference Manual](https://www.st.com/resource/en/reference_manual/rm0440-stm32g4-series-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)
- [Renode Platform Descriptions](https://github.com/renode/renode/tree/master/platforms/cpus)

---

## üîß –¢–ï–ö–£–©–ò–ï –§–ê–ô–õ–´

### `renode/stm32g431cb.repl`:
–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ —Å:
- Cortex-M4 CPU @ 170 MHz
- 128KB Flash, 32KB RAM
- USART1 @ 0x40013800 (STM32F7_USART)
- DMA1, DMA2 @ 0x40020000, 0x40020400
- GPIO, RCC, PWR, DBGMCU stubs

### `build.rs`:
```rust
fn main() {
    println!("cargo:rustc-link-arg-bins=--nmagic");
    println!("cargo:rustc-link-arg-bins=-Tlink.x");
    println!("cargo:rustc-link-arg-bins=-Tdefmt.x");
}
```

### `Cargo.toml` (–∫–ª—é—á–µ–≤—ã–µ features):
```toml
cortex-m = { version = "0.7.6", features = ["critical-section-single-core"] }
embassy-stm32 = { version = "0.4.0", features = ["stm32g431cb", "memory-x", "time-driver-any", "unstable-pac", "exti"] }
embassy-time = { version = "0.5.0", features = ["defmt", "defmt-timestamp-uptime", "tick-hz-32_768"] }

[profile.release]
opt-level = "z"
lto = true
debug = 2
```

---

## ‚úÖ –í–´–í–û–î

**–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ (fix linker) - –í–´–ü–û–õ–ù–ï–ù–ê!** üéâ

–ü—Ä–æ—à–∏–≤–∫–∞:
- ‚úÖ –ö–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –õ–∏–Ω–∫—É–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º Entry Point
- ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ Renode
- ‚úÖ –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚ö†Ô∏è –ù–µ –≤—ã–≤–æ–¥–∏—Ç –≤ UART (–æ—Ç–¥–µ–ª—å–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —ç–º—É–ª—è—Ü–∏–∏)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å **–í–∞—Ä–∏–∞–Ω—Ç–∞ 1 (blocking UART)** –∫–∞–∫ —Å–∞–º–æ–≥–æ –±—ã—Å—Ç—Ä–æ–≥–æ —Å–ø–æ—Å–æ–±–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≥–∏–ø–æ—Ç–µ–∑—É –æ DMA.
