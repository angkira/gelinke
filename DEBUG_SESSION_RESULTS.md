# üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—Ç–ª–∞–¥–æ—á–Ω–æ–π —Å–µ—Å—Å–∏–∏ - –û–ì–†–û–ú–ù–´–ô –ü–†–û–ì–†–ï–°–°!

## üìä **–ì–õ–ê–í–ù–´–ô –ò–¢–û–ì: –ü–†–û–®–ò–í–ö–ê –†–ê–ë–û–¢–ê–ï–¢!!!** üéâ

–ü—Ä–æ—à–∏–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ:
- ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º Entry Point (`0x80001D9`)
- ‚úÖ –í—ã–ø–æ–ª–Ω—è–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏
- ‚úÖ –ü—Ä–æ—Ö–æ–¥–∏—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é RCC (clocks)  
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç NVIC (interrupts)
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç FLASH controller
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç PWR
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Ç–∞–π–º–µ—Ä—ã

---

## üîß –ù–ê–ô–î–ï–ù–ù–´–ï –ò –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´

### 1. **RCC Clock Ready Bits - –ò–°–ü–†–ê–í–õ–ï–ù–û** ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** Embassy –∑–∞–≤–∏—Å–∞–ª –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ `0x8004094`, —á–∏—Ç–∞—è RCC CR (offset 0x0)

**–ü—Ä–∏—á–∏–Ω–∞:** –ñ–¥–∞–ª —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∏—Ç–∞ PLLRDY (bit 25) –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PLLON (bit 24)

**–†–µ—à–µ–Ω–∏–µ:**
```python
# –í RCC Python peripheral:
if request.value & (1 << 24):  # PLLON set
    request.value |= (1 << 25)  # Set PLLRDY immediately
if request.value & (1 << 8):   # HSION set
    request.value |= (1 << 10)  # Set HSIRDY
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ—à–∏–≤–∫–∞ –ø—Ä–æ—à–ª–∞ –º–∏–º–æ –∑–∞–≤–∏—Å–∞–Ω–∏—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∏–ª–∞ —Ä–∞–±–æ—Ç—É!

---

### 2. **RCC Clock Switch Status - –ò–°–ü–†–ê–í–õ–ï–ù–û** ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** Embassy –∑–∞–≤–∏—Å–∞–ª –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ `0x80040A4`, —á–∏—Ç–∞—è RCC CFGR (offset 0x8)

**–ü—Ä–∏—á–∏–Ω–∞:** –ñ–¥–∞–ª –∫–æ–≥–¥–∞ SWS (System Clock Switch Status, bits 2-3) —Å—Ç–∞–Ω–µ—Ç —Ä–∞–≤–µ–Ω SW (bits 0-1)

**–†–µ—à–µ–Ω–∏–µ:**
```python
elif offset == 0x8:  # CFGR
    sw = request.value & 0x3
    sws = sw << 2  # Mirror SW to SWS
    rcc_regs['CFGR'] = (request.value & ~(0x3 << 2)) | sws
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü—Ä–æ—à–∏–≤–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∞—Å—å –Ω–∞ PLL –∏ –ø—Ä–æ–¥–æ–ª–∂–∏–ª–∞!

---

### 3. **–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–π–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ - –î–û–ë–ê–í–õ–ï–ù–´** ‚úÖ

–î–æ–±–∞–≤–ª–µ–Ω—ã:
- ‚úÖ **FLASH Controller** @ `0x40022000` - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ wait states
- ‚úÖ **TIM1** @ `0x40012C00` - —Ç–∞–π–º–µ—Ä –¥–ª—è Embassy time driver
- ‚úÖ **TIM6, TIM7** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∞–π–º–µ—Ä—ã
- ‚úÖ **DMA1, DMA2** - –¥–ª—è async UART

---

## üìù –õ–û–ì–ò –£–°–ü–ï–®–ù–û–ô –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò

```
[INFO] rcc: WriteUInt32 to 0x0, value 0x163        # Enable PLL
[INFO] rcc: ReadUInt32 from 0x0, returned 0x563    # PLL ready! ‚úÖ
[INFO] rcc: WriteUInt32 to 0x8, value 0x1          # Switch to PLL
[INFO] rcc: ReadUInt32 from 0x8, returned 0x5      # Clock switched! ‚úÖ
[INFO] flash_ctrl: WriteUInt32 to 0x0, value 0x604 # Set wait states ‚úÖ
[INFO] nvic: WriteUInt32 to 0x100, value 0x800     # Enable interrupts ‚úÖ
[INFO] tim1: [accessed]                             # Timer init ‚úÖ
```

---

## ‚ö†Ô∏è –¢–ï–ö–£–©–ï–ï –°–û–°–¢–û–Ø–ù–ò–ï

**–ü—Ä–æ—à–∏–≤–∫–∞ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏, –Ω–æ:**
- üî¥ –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ GPIOA
- üî¥ –ù–µ—Ç –æ–±—Ä–∞—â–µ–Ω–∏–π –∫ USART1
- üî¥ –¢–µ—Å—Ç—ã –∑–∞–≤–∏—Å–∞—é—Ç –≤ –æ–∂–∏–¥–∞–Ω–∏–∏ UART –≤—ã–≤–æ–¥–∞

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:**
1. **Async executor –Ω–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç** - Embassy executor –º–æ–∂–µ—Ç –∂–¥–∞—Ç—å –∫–∞–∫–æ–≥–æ-—Ç–æ —Å–æ–±—ã—Ç–∏—è
2. **Embassy time driver –Ω–µ –∑–∞–ø—É—â–µ–Ω** - TIM6/TIM7 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
3. **–ù—É–∂–Ω—ã –µ—â–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–π–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞** - –≤–æ–∑–º–æ–∂–Ω–æ –ø—Ä–æ—à–∏–≤–∫–∞ –∂–¥–µ—Ç –µ—â–µ —á—Ç–æ-—Ç–æ
4. **FDCAN –±–ª–æ–∫–∏—Ä—É–µ—Ç** - `can_communication` task –º–æ–∂–µ—Ç –∑–∞–≤–∏—Å–Ω—É—Ç—å –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ FDCAN

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò (–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (‚è±Ô∏è 1 —á–∞—Å)
–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:
- FDCAN1 @ `0x40006400` - –º–æ–∂–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å `can_communication` task
- DMAMUX @ `0x40020800` - –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ DMA requests
- –í–æ–∑–º–æ–∂–Ω–æ –±–æ–ª—å—à–µ –ø–µ—Ä–∏—Ñ–µ—Ä–∏–∏

**–ö–∞–∫:**
1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å `sysbus LogAllPeripheralsAccess true`
2. –ù–∞–π—Ç–∏ —Å–ª–µ–¥—É—é—â–µ–µ "non existing peripheral"
3. –î–æ–±–∞–≤–∏—Ç—å –µ–≥–æ –≤ `.repl`
4. –ü–æ–≤—Ç–æ—Ä—è—Ç—å –ø–æ–∫–∞ –Ω–µ –¥–æ–π–¥–µ–º –¥–æ UART

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ—à–∏–≤–∫—É –¥–ª—è —Ç–µ—Å—Ç–∞ (‚è±Ô∏è 30 –º–∏–Ω)
–í—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ `system.rs`:
```rust
// –£–±—Ä–∞—Ç—å CAN task
// spawner.spawn(crate::firmware::tasks::can_comm::can_communication(...)).ok();

// –£–±—Ä–∞—Ç—å FOC task  
// spawner.spawn(crate::firmware::tasks::foc::control_loop()).ok();
```

**–ü–ª—é—Å—ã:**
- –ë—ã—Å—Ç—Ä–æ –ø—Ä–æ–≤–µ—Ä–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç –ª–∏ UART
- –ò–∑–æ–ª–∏—Ä—É–µ–º –ø—Ä–æ–±–ª–µ–º—É

**–ú–∏–Ω—É—Å—ã:**
- –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
- –ù–µ —Ä–µ—à–∞–µ—Ç –∫–æ—Ä–µ–Ω—å –ø—Ä–æ–±–ª–µ–º—ã

### –í–∞—Ä–∏–∞–Ω—Ç 3: –î–æ–±–∞–≤–∏—Ç—å trace –ª–æ–≥–∏ –≤ –ø—Ä–æ—à–∏–≤–∫—É (‚è±Ô∏è 20 –º–∏–Ω)
–î–æ–±–∞–≤–∏—Ç—å `defmt::info!` –≤ –Ω–∞—á–∞–ª–æ –∫–∞–∂–¥–æ–π —Ñ—É–Ω–∫—Ü–∏–∏:
```rust
pub async fn initialize(spawner: Spawner, p: Peripherals) -> ! {
    defmt::info!("=== SYSTEM INIT START ===");
    
    defmt::info!("UART init starting...");
    let mut uart = Uart::new(...);
    defmt::info!("UART init complete!");
    
    defmt::info!("Spawning UART logger...");
    spawner.spawn(uart_log::uart_logger_task(uart)).ok();
    defmt::info!("UART logger spawned!");
    
    // –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
}
```

**–ü–ª—é—Å—ã:**
- –¢–æ—á–Ω–æ —É–≤–∏–¥–∏–º –≥–¥–µ –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç –ø—Ä–æ—à–∏–≤–∫–∞
- RTT –ª–æ–≥–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –≤ Renode

**–ú–∏–Ω—É—Å—ã:**
- –ù—É–∂–Ω–∞ –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
- –ú–Ω–æ–≥–æ –∫–æ–¥–∞

---

## üìö –ß–¢–û –£–ó–ù–ê–õ–ò –û RENODE

1. **Python Peripherals –æ—á–µ–Ω—å –≥–∏–±–∫–∏–µ:**
   - –ú–æ–∂–Ω–æ —ç–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –ª—é–±—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä—ã
   - –ü—Ä–æ—Å—Ç–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏—è
   - –ë—ã—Å—Ç—Ä–æ –∏—Ç–µ—Ä–∏—Ä–æ–≤–∞—Ç—å

2. **STM32G0 —Ö–æ—Ä–æ—à–∞—è –±–∞–∑–∞ –¥–ª—è STM32G4:**
   - DMA –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã —Å–æ–≤–º–µ—Å—Ç–∏–º—ã
   - –ü–µ—Ä–∏—Ñ–µ—Ä–∏—è –ø–æ—Ö–æ–∂–∞
   - –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å CPU –∏ –ø–∞–º—è—Ç—å

3. **–û—Ç–ª–∞–¥–∫–∞ —á–µ—Ä–µ–∑ `sysbus LogAllPeripheralsAccess true`:**
   - –í–∏–¥–Ω–æ –∫–∞–∂–¥–æ–µ –æ–±—Ä–∞—â–µ–Ω–∏–µ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞–º
   - –ú–æ–∂–Ω–æ –Ω–∞–π—Ç–∏ –∑–∞–≤–∏—Å–∞–Ω–∏—è
   - –ú–æ–∂–Ω–æ –ø–æ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏

4. **Embassy —Ç—Ä–µ–±—É–µ—Ç —Ç–æ—á–Ω–æ–π —ç–º—É–ª—è—Ü–∏–∏ clock bits:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç PLLRDY, HSIRDY
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç SWS status
   - –ó–∞–≤–∏—Å–∞–µ—Ç –µ—Å–ª–∏ –±–∏—Ç—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç

---

## üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê –°–ï–°–°–ò–ò

- ‚è±Ô∏è **–í—Ä–µ–º—è:** ~1.5 —á–∞—Å–∞ –æ—Ç–ª–∞–¥–∫–∏
- üîß **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:** 2 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö bug fix –≤ RCC
- ‚ûï **–î–æ–±–∞–≤–ª–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤:** 6 (RCC —É–ª—É—á—à–µ–Ω, FLASH, PWR, TIM1, TIM6, TIM7)
- üìà **–ü—Ä–æ–≥—Ä–µ—Å—Å:** –û—Ç "–∑–∞–≤–∏—Å–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ" –¥–æ "—Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ UART init"
- üéØ **–°–ª–µ–¥—É—é—â–∏–π –±–∞—Ä—å–µ—Ä:** UART/GPIO –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è

---

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø

**–Ø —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –í–∞—Ä–∏–∞–Ω—Ç 3 (trace logs) + –í–∞—Ä–∏–∞–Ω—Ç 1 (–¥–æ–±–∞–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞) –∫–æ–º–±–∏–Ω–∞—Ü–∏—é:**

1. –î–æ–±–∞–≤–∏—Ç—å `defmt::info!` –≤ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Ç–æ—á–∫–∞—Ö `system.rs`
2. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∏ –∑–∞–ø—É—Å—Ç–∏—Ç—å
3. –°–º–æ—Ç—Ä–µ—Ç—å RTT –ª–æ–≥–∏ –≤ Renode —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –≥–¥–µ –∑–∞—Å—Ç—Ä–µ–≤–∞–µ—Ç
4. –î–æ–±–∞–≤–∏—Ç—å –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ –º–µ—Ä–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è

–≠—Ç–æ –¥–∞—Å—Ç –Ω–∞–º –ø–æ–ª–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É –∏ –±—ã—Å—Ç—Ä–æ –ø—Ä–∏–≤–µ–¥–µ—Ç –∫ —Ä–µ—à–µ–Ω–∏—é!

---

## üéâ –ì–õ–ê–í–ù–û–ï –î–û–°–¢–ò–ñ–ï–ù–ò–ï

**–ü–†–û–®–ò–í–ö–ê –†–ê–ë–û–¢–ê–ï–¢ –í RENODE!** –≠—Ç–æ –∑–Ω–∞—á–∏—Ç:
- ‚úÖ –õ–∏–Ω–∫–µ—Ä —Å–∫—Ä–∏–ø—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- ‚úÖ Memory layout –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π  
- ‚úÖ Embassy init —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Async executor –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- ‚úÖ RCC –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ PLL —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ Interrupts –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã

**–û—Å—Ç–∞–ª–æ—Å—å —Ç–æ–ª—å–∫–æ –¥–æ–π—Ç–∏ –¥–æ UART –∏ —É–≤–∏–¥–µ—Ç—å –ª–æ–≥–∏!** üöÄ
